<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nicolas Saby1, and Thomas Opitz2">
<meta name="dcterms.date" content="2023-04-24">

<title>inlabru : Convenient fitting of Bayesian digital soil mapping models using INLA-SPDE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="pedometron_files/libs/clipboard/clipboard.min.js"></script>
<script src="pedometron_files/libs/quarto-html/quarto.js"></script>
<script src="pedometron_files/libs/quarto-html/popper.min.js"></script>
<script src="pedometron_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="pedometron_files/libs/quarto-html/anchor.min.js"></script>
<link href="pedometron_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="pedometron_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="pedometron_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="pedometron_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="pedometron_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">inlabru : Convenient fitting of Bayesian digital soil mapping models using INLA-SPDE</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    Nicolas Saby 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            INRAE, Info&amp;Sols, Orléans, France
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    <a href="https://biosp.mathnum.inrae.fr/homepage-thomas-opitz">Thomas Opitz</a> 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            INRAE, BioSP, Avignon, France
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 24, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><sup>1</sup> INRAE, Info&amp;Sols, Orléans, France<br>
<sup>2</sup> INRAE, BioSP, Avignon, France</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Pedometricians are nowadays heavy users of Machine Learning (ML) approaches with on the top the widely used random forest algorithm, see for example <span class="citation" data-cites="poggio_soilgrids_2021">(<a href="#ref-poggio_soilgrids_2021" role="doc-biblioref">L. Poggio et al. 2021</a>)</span>. These algorithms are indeed particularly well adapted to the management of large data sets to map soil properties on large geographic areas in a wide range of situations. The techniques are based on classification and regression algorithms, but they take no account of spatial correlations in residuals <span class="citation" data-cites="HEUVELINK2022100639">(<a href="#ref-HEUVELINK2022100639" role="doc-biblioref">Heuvelink and Webster 2022</a>)</span>. This trend towards heavy use of ML tools also seems to be accompanied by a diminished use of geostatistical techniques that often require more computer resources but also profound statistical skills to construct and fine-tune models. Often, prediction is performed in several steps (<em>eg</em> regression or any other machine learning prediction in step 1, followed by spatial kriging of the residuals in step 2), but then an accurate assessment of the prediction uncertainties is difficult since uncertainties from the first step must be propagated through to the second step.</p>
<p>In this paper, we propose to solve these issues by using the fully Bayesian estimation framework based on the integrated nested Laplace approximation (INLA,<span class="citation" data-cites="Rue2009">(<a href="#ref-Rue2009" role="doc-biblioref">Rue, Martino, and Chopin 2009</a>)</span>), combined with the so-called stochastic partial differential equation approach <span class="citation" data-cites="Lindgren2011">(SPDE, <a href="#ref-Lindgren2011" role="doc-biblioref">Lindgren, Rue, and Lindström 2011</a>)</span> providing numerically convenient representations of Gaussian processes over continuous space. Over the last decade, the INLA method has become the most popular tool in spatial statistics for estimating a wide variety of Generalized Additive Mixed Models (i.e., Generalized Additive Models with random effects) in a Bayesian setting. It is a relatively easy-to-use alternative to traditional Markov chain Monte Carlo methods by providing off-the-shelf implementation of fast and accurate deterministic approximations of posterior inferences for a large class of models. INLA with SPDE is a powerful combination to handle very large spatial data sets. Models are formulated as Bayesian hierarchical models where covariate effects and Gaussian processes can be additively included in a latent process (that is not directly), whereas the probability distribution of observations can be of various nature (continuous such as gaussian, skew-gaussian, gamma, extreme-value, or discrete such as Poisson, binomial, negative binomial) and its parameters are controlled by the latent process.</p>
<p>INLA-SPDE was already introduced by <span class="citation" data-cites="Poggio2016">(<a href="#ref-Poggio2016" role="doc-biblioref">Laura Poggio et al. 2016</a>)</span> or <span class="citation" data-cites="Huang2017">(<a href="#ref-Huang2017" role="doc-biblioref">Huang 2017</a>)</span> to the pedometrics community. However, wider use of this approach by the community was probably hindered by the complexity of the INLA R package. Recently, the <code>inlabru</code> R package <span class="citation" data-cites="yuan2017point">(<a href="#ref-yuan2017point" role="doc-biblioref">Yuan et al. 2017</a>)</span>, originally developed with a strong focus on point process models for discrete data in ecology, has integrated a range of functions to help in implementing INLA-SPDE models in a more convenient way through a more ergonomic interface. We propose here to illustrate how this package works by using a simple and classical regression kriging approach as an example.</p>
</section>
<section id="set-up" class="level1">
<h1>Set up</h1>
<section id="load-packages" class="level2">
<h2 class="anchored" data-anchor-id="load-packages">Load packages</h2>
<p>We use here the set of R packages given in the list below.</p>
<p>The latest version of R (eg &gt;4.2) should be installed on your computer for using the <code>inlabru</code> package. The classical dataset for the Meuse area that we use here is available in the <code>gstat</code>package.</p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(inlabru)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat) <span class="co"># for the meuse data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>inlabru</code> method is a convenient wrapper for the <code>INLA::inla</code> function and provides multiple enhancements, such as an improved integration of spatial object classes of type <code>sp</code> in R, more convenient syntax for defining the structure of the model, convenient functions to perform Bayesian prediction using simulations from the estimated posterior model, and estimation facilities for certain model structures that are not possible with the classical <code>INLA</code> package.</p>
</section>
<section id="point-data-and-rasters" class="level2">
<h2 class="anchored" data-anchor-id="point-data-and-rasters">Point data and rasters</h2>
<p>We use the open data <code>meuse</code> from the <code>gstat</code> package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(meuse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(meuse.grid)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(meuse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   155 obs. of  14 variables:
 $ x      : num  181072 181025 181165 181298 181307 ...
 $ y      : num  333611 333558 333537 333484 333330 ...
 $ cadmium: num  11.7 8.6 6.5 2.6 2.8 3 3.2 2.8 2.4 1.6 ...
 $ copper : num  85 81 68 81 48 61 31 29 37 24 ...
 $ lead   : num  299 277 199 116 117 137 132 150 133 80 ...
 $ zinc   : num  1022 1141 640 257 269 ...
 $ elev   : num  7.91 6.98 7.8 7.66 7.48 ...
 $ dist   : num  0.00136 0.01222 0.10303 0.19009 0.27709 ...
 $ om     : num  13.6 14 13 8 8.7 7.8 9.2 9.5 10.6 6.3 ...
 $ ffreq  : Factor w/ 3 levels "1","2","3": 1 1 1 1 1 1 1 1 1 1 ...
 $ soil   : Factor w/ 3 levels "1","2","3": 1 1 1 2 2 2 2 1 1 2 ...
 $ lime   : Factor w/ 2 levels "0","1": 2 2 2 1 1 1 1 1 1 1 ...
 $ landuse: Factor w/ 15 levels "Aa","Ab","Ag",..: 4 4 4 11 4 11 4 2 2 15 ...
 $ dist.m : num  50 30 150 270 380 470 240 120 240 420 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(meuse.grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   3103 obs. of  7 variables:
 $ x     : num  181180 181140 181180 181220 181100 ...
 $ y     : num  333740 333700 333700 333700 333660 ...
 $ part.a: num  1 1 1 1 1 1 1 1 1 1 ...
 $ part.b: num  0 0 0 0 0 0 0 0 0 0 ...
 $ dist  : num  0 0 0.0122 0.0435 0 ...
 $ soil  : Factor w/ 3 levels "1","2","3": 1 1 1 1 1 1 1 1 1 1 ...
 $ ffreq : Factor w/ 3 levels "1","2","3": 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
</div>
</div>
<p>The first action is to create <code>sp</code> objects:</p>
<ul>
<li><p>a <code>SpatialPointsDataFrame</code> corresponding to the regression matrix and,</p></li>
<li><p>the prediction grid, here already provided in the <code>meuse.grid</code>-object along with covariates.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(meuse) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(meuse.grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gridded</span>(meuse.grid) <span class="ot">=</span> <span class="cn">TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="fully-bayesian-dsm-approach" class="level1">
<h1>Fully Bayesian DSM approach</h1>
<section id="the-hierarchical-dsm-model" class="level2">
<h2 class="anchored" data-anchor-id="the-hierarchical-dsm-model">The hierarchical DSM model</h2>
<p>We construct a hierarchical model for the soil property <span class="math inline">\(z(s)\)</span> of a spatial location <span class="math inline">\(s\)</span> in the framework of the prediction in the presence of exhaustive ancillary information. We will assume the following linkage between model components and observations, where we denote the latent process by <span class="math inline">\(\eta(s)\)</span>.</p>
<p><span class="math display">\[
\eta(s) \sim {\text{Intercept}} + \underbrace{ \sum_{i\in \text{scorpan}}\beta_i z_i(s)}_{\text{Covariates} } +\underbrace{W(s)}_{\text{Spatial Gaussian field}}
\]</span> The spatial field <span class="math inline">\(W(s)\)</span> captures autocorrelation not explained by the covariates. The latent process <span class="math inline">\(\eta(s)\)</span> will then be used in the observation-likelihood, which is here chosen as gaussian. We use the <code>|</code> notation to indicate conditioning of the property at the left side of <code>|</code> o the parameters given to the right side of <code>|</code>. This leads to the following hierarchical formulation for the observations,</p>
<p><span class="math display">\[
z(s) | (\eta(s),\theta) \sim \Gamma(\exp(\eta(s_i)), \tau),
\]</span> where the Gamma distribution is parametrized in a way such that <span class="math inline">\(\exp(\eta(s_i))\)</span> is its mean and <span class="math inline">\(\tau\)</span> is a dispersion parameter related to the variance around the mean. <span class="math inline">\(\theta = (\theta_\eta, \tau)\)</span> with <span class="math inline">\(\theta_\eta\)</span> the hyperparameters controlling the linear predictors <span class="math inline">\(\eta\)</span>.</p>
<p>Moreover different observations <span class="math inline">\(z(s)\)</span> are conditionally independent given the latent process <span class="math inline">\(\eta(s)\)</span> and the hyperparameters in <span class="math inline">\(\theta\)</span> controlling it. This means that we include a <code>nugget effect</code> or <code>measurement error</code> with variance <span class="math inline">\(\sigma^2\)</span> in the model.</p>
<p>In this paper, <span class="math inline">\(z\)</span> will correspond to the organic matter, <code>om</code>.</p>
</section>
<section id="construction-of-the-mesh-for-the-spde-model" class="level2">
<h2 class="anchored" data-anchor-id="construction-of-the-mesh-for-the-spde-model">Construction of the mesh for the SPDE model</h2>
<p><code>INLA</code> and <code>inlabru</code> use a space triangulation method to estimate spatial Gaussian effects with a Matérn covariance function. The latent spatial Gaussian random field is computed at the mesh nodes by resolving a Stochastic Partial Differential Equation (SPDE), while it is computed elsewhere by linear interpolation between the mesh nodes. The mesh definition is based on a trade-off between the finer spatial scale of the spatial effect (higher resolution) and a lower number of nodes (lower resolution), where having less nodes usually comes with faster calculations. Many applications already come with a regular grid used to discretize space, such as the <code>meuse.grid</code> object here, but often it still makes sense to choose different nodes for the space triangulation used to represent the Gaussian field <span class="math inline">\(W(s)\)</span>, especially in cases where the resolution of the grid from the data is too high for being handled directly by INLA. Below, we present how to build a mesh where the construction of the mesh nodes is initialized using the set of coordinates of the calibration sites. This makes sense since can be useful to have a mesh that is relatively denser in areas with many calibration sites (where data provide more information).</p>
<p>First, we create a matrix <code>xyMesh</code> with coordinates of the sites. Next, we define the boundaries of the domain used for computing the spatial latent effect with the SPDE approach. Generally, it is better to compute an internal boundary (delimiting the study area where we want to predict) and an external boundary (providing an extension zone around the study area that is necessary to avoid strong boundary effects from the SPDE) with different resolutions. The purpose of the extension zone is to push the outer boundary away from the study area, and we can set a lower mesh resolution in this extension zone where we do not want to predict the soil property.</p>
<p>The <code>INLA::inla.mesh.2d</code> function creates a triangle mesh based on initial point locations, specified or automatic boundaries, and mesh quality parameters, in particular the <code>cutoff</code>. This tuning parameter sets the minimum length of edges between two nodes and allows to keep the number of nodes at most moderately high and to avoid instabilities in computations related to the covariance structure due to very high Gaussian correlation at nodes that are very close in space. More information is provided here: https://rpubs.com/jafet089/886687</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cutoffValue <span class="ot">=</span> <span class="dv">50</span> <span class="co"># in meter</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>xyMesh <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">coordinates</span>(meuse)) <span class="co"># transform into matrix</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>max.edge <span class="ot">=</span> <span class="fu">diff</span>(<span class="fu">range</span>(xyMesh[,<span class="dv">1</span>]))<span class="sc">/</span>(<span class="dv">3</span><span class="sc">*</span><span class="dv">5</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>bound.outer <span class="ot">=</span> <span class="fu">diff</span>(<span class="fu">range</span>(<span class="fu">range</span>(xyMesh[,<span class="dv">1</span>])))<span class="sc">/</span><span class="dv">3</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>bndint <span class="ot">&lt;-</span> <span class="fu">inla.nonconvex.hull</span>(meuse, <span class="at">convex=</span><span class="sc">-</span>.<span class="dv">05</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>bndext <span class="ot">&lt;-</span> <span class="fu">inla.nonconvex.hull</span>(meuse, <span class="at">convex=</span><span class="sc">-</span>.<span class="dv">3</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Use of inla.mesh.2d </span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.2d</span>(<span class="at">loc=</span>xyMesh,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">boundary =</span> <span class="fu">list</span>(<span class="at">int =</span> bndint,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">out =</span> bndext),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)<span class="sc">*</span>max.edge, </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                    <span class="at">cutoff =</span> cutoffValue,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">crs =</span> meuse<span class="sc">@</span>proj4string<span class="sc">@</span>projargs)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(mesh) <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(meuse) <span class="sc">+</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pedometron_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="defining-the-spatial-gaussian-random-field-ws" class="level2">
<h2 class="anchored" data-anchor-id="defining-the-spatial-gaussian-random-field-ws">Defining the spatial Gaussian random field <span class="math inline">\(W(s)\)</span></h2>
<p>We choose the Matérn covariance function for the Gaussian random field because it can be easily used within <code>INLA</code> through the SPDE approach providing convenient numerical representations for estimation with large numbers of observations and mesh nodes. The Matérn covariance in <code>INLA</code> depends on three parameters: - a fractional order parameter *alpha* in the SPDE linked to the smoothness of the solution (which has to be fixed by the user), - a standard deviation parameter *sigma* and, - a spatial correlation parameter known as the *range*.</p>
<p>We specify these parameters in our model by selecting a penalized complexity prior using the <code>INLA::inla.spde2.pcmatern</code> function. For more details, please refer to the introduction to spatial models with <code>INLA</code> in chapter 7 at &lt;https://becarioprecario.bitbucket.io/inla-gitbook/ch-spatial.html&gt;.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>matern <span class="ot">&lt;-</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  INLA<span class="sc">::</span><span class="fu">inla.spde2.pcmatern</span>(mesh,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>),<span class="co"># P(sigma &gt; 1) = 0.5</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="fl">0.9</span>)  <span class="co"># P(range &lt; 10000 m) = 0.9</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="specify-the-hierarchical-model" class="level2">
<h2 class="anchored" data-anchor-id="specify-the-hierarchical-model">Specify the hierarchical model</h2>
<p>We then specify the model components in the <code>cmp</code> object using the convenient <code>inlabru</code> approach. We use as example the following latent effects: an intercept, a linear relationship with the covariate as fixed effect corresponding to the distance to the river, and the Gaussian random field as random effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cmp <span class="ot">&lt;-</span> om <span class="sc">~</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">field</span>(coordinates, <span class="at">model =</span> matern) <span class="sc">+</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Intercept</span>(<span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dist</span>(dist, <span class="at">model =</span> <span class="st">'linear'</span> )     </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we fit the hierarchical model to the data using the <code>bru</code> function of the <code>inlabru</code> package. This function requires the model components defined earlier (<code>cmp</code>), the dataset (<code>meuse</code>), the mesh (<code>mesh</code>) where the model will be evaluated, and several options to control the INLA algorithm.</p>
<p>For handling the uncertainty stemming from the prior distributions of hyperparameters (here the standard deviation and the correlation range), we use the <code>eb</code> strategy as it is much quicker to compute but a bit less accurate. This <code>empirical Bayes</code> approach sets the hyperparameters to their <code>maximum a posteriori</code> for some of the calculations performed during the estimation algorithm, that is, it uses a mechanism similar to frequentist inference techniques for handling the hyperparameters.</p>
<p>One need to indicate the likelihood family such as <code>gaussian</code>, <code>poisson</code> or <code>binomial</code>. By default family is <code>gaussian</code>. A list of possible alternatives can be seen by typing <code>names(inla.models()$likelihood)</code>. It is therefore possible to fit a wide range of model allowing to approach a great diversity of problems in soil science. We use here the <code>gamma</code> family to cope with heavy tail.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> inlabru<span class="sc">::</span><span class="fu">bru</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">components =</span> cmp,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> meuse,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gamma"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">coordinates =</span> mesh),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">control.inla =</span> <span class="fu">list</span>(<span class="at">int.strategy =</span> <span class="st">"eb"</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The summary of the fitted model gives the posterior estimates of fixed effects (intercept and elevation) and hyperparameters (standard deviation and range of the Gaussian random field).</p>
<p>We can look at some summaries of the posterior distributions for the parameters, for example the fixed effects (i.e.&nbsp;the intercept) and the hyper-parameters (i.e.&nbsp;variance of the gaussian likelihood, the precision of the RW1, and the parameters of the spatial field):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>inlabru version: 2.7.0
INLA version: 22.12.16
Components:
field: main = spde(coordinates)
Intercept: main = linear(1)
dist: main = linear(dist)
Likelihoods:
  Family: 'gamma'
    Data class: 'SpatialPointsDataFrame'
    Predictor: om ~ .
Time used:
    Pre = 1.21, Running = 1.12, Post = 0.061, Total = 2.39 
Fixed effects:
            mean    sd 0.025quant 0.5quant 0.975quant   mode kld
Intercept  2.349 0.223      1.912    2.349      2.785  2.349   0
dist      -1.311 0.390     -2.076   -1.311     -0.547 -1.311   0

Random effects:
  Name    Model
    field SPDE2 model

Model hyperparameters:
                                                   mean      sd 0.025quant
Precision parameter for the Gamma observations   14.227   2.487      9.969
Range for field                                1760.210 831.848    781.674
Stdev for field                                   0.555   0.175      0.318
                                               0.5quant 0.975quant    mode
Precision parameter for the Gamma observations    14.01     19.738   13.58
Range for field                                 1558.31   3944.185 1227.82
Stdev for field                                    0.52      0.996    0.45

Deviance Information Criterion (DIC) ...............: 664.90
Deviance Information Criterion (DIC, saturated) ....: 203.62
Effective number of parameters .....................: 47.08

Watanabe-Akaike information criterion (WAIC) ...: 661.10
Effective number of parameters .................: 35.86

Marginal log-Likelihood:  -366.62 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
</section>
</section>
<section id="spatial-predictions" class="level1">
<h1>Spatial predictions</h1>
<p>Now we use the fit to predict the field on a lattice, and therefore generate a set of results using 100 realizations from the posterior distribution of the model. The approach of using posterior simulation for prediction allows us to appropriately represent the uncertainties in the predictions, and we can choose very flexibly for which parameters and properties we would like to provide predictions. In the predictor formula, we use the <code>exp</code> function to take into account the log-link between the mean of the gamma distribution of the <code>om</code> variable and our linear predictor.</p>
<p>In the predictor formula, we use the <code>exp</code> function to take into account the log-link between the mean of the gamma distribution of the <code>om</code> variable and our linear predictor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  fit,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.samples =</span> <span class="dv">100</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  meuse.grid,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">exp</span>(field <span class="sc">+</span> Intercept <span class="sc">+</span> dist) ,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.threads =</span> <span class="dv">2</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Internally, the <code>predict</code> function draws samples from the posterior distribution and then combines them to provide the requested predictions. It is also very simple to perform the sampling step directly to obtain the posterior samples using the <code>generate</code> function. For illustration, we here we draw 5 samples and select the first one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>samp <span class="ot">&lt;-</span> <span class="fu">generate</span>(fit, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                 meuse.grid,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">~</span> <span class="fu">exp</span>(field <span class="sc">+</span> Intercept <span class="sc">+</span> dist) ,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n.samples =</span> <span class="dv">5</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(samp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:3103, 1:5] 14.3 14.5 14.8 14 14.3 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>sample <span class="ot">&lt;-</span> samp[, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plotting-results" class="level1">
<h1>Plotting results</h1>
<section id="the-different-effects" class="level2">
<h2 class="anchored" data-anchor-id="the-different-effects">The different effects</h2>
<p>We can plot the posterior densities for the latent effect <code>Intercept</code> and <code>distance</code> to the border.</p>
<p>To this end we will use the <code>inlabru::plot()</code> function,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">plot</span>(fit, <span class="st">"Intercept"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">plot</span>(fit, <span class="st">"dist"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">multiplot</span>(p1, p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pedometron_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As the credibility interval does not contains 0, we can conclude to a significant effect of the fixed effect.</p>
<p>We can also plot the posterior distribution of the parameters of the gaussiant field: range and variance</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>spde.range.W0 <span class="ot">&lt;-</span> <span class="fu">spde.posterior</span>(fit, <span class="st">"field"</span>, <span class="at">what =</span> <span class="st">"range"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>spde.logvar.W0 <span class="ot">&lt;-</span> <span class="fu">spde.posterior</span>(fit, <span class="st">"field"</span>, <span class="at">what =</span> <span class="st">"variance"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>range.plot.W0 <span class="ot">&lt;-</span> <span class="fu">plot</span>(spde.range.W0)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>var.plot.W0 <span class="ot">&lt;-</span> <span class="fu">plot</span>(spde.logvar.W0)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">multiplot</span>(range.plot.W0, var.plot.W0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pedometron_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="the-spatial-predictions-with-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="the-spatial-predictions-with-uncertainty">The spatial predictions with uncertainty</h2>
<p>We can plot the median, lower 95% and upper 95% density surfaces as follows (assuming that the predicted intensity is in object <code>pred</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># correction of negative predictions</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>q0<span class="fl">.025</span>[pred<span class="sc">$</span>q0<span class="fl">.025</span><span class="sc">&lt;</span><span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pred) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"q0.025"</span>,<span class="st">"median"</span>,<span class="st">"q0.975"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pedometron_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="one-realization-of-the-posterior-distribution" class="level2">
<h2 class="anchored" data-anchor-id="one-realization-of-the-posterior-distribution">One realization of the posterior distribution</h2>
<p>The sample from the posterior distribution can be mapped as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pred) <span class="sc">+</span> <span class="fu">tm_raster</span>(<span class="st">"sample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pedometron_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="the-maps-of-the-random-and-the-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="the-maps-of-the-random-and-the-fixed-effects">The maps of the random and the fixed effects</h2>
<p>Next, we plot the 2 effects of the model:</p>
<ul>
<li><p>the spatial Gaussian random field <span class="math inline">\(W(s)\)</span>,</p></li>
<li><p>the fixed effect.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  fit,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.samples =</span> <span class="dv">100</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  meuse.grid,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> field  ,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.threads =</span> <span class="dv">2</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>fixed <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  fit,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.samples =</span> <span class="dv">100</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  meuse.grid,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>  <span class="fu">exp</span>(Intercept <span class="sc">+</span> dist)  ,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.threads =</span> <span class="dv">2</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>FixedEffect <span class="ot">&lt;-</span> fixed<span class="sc">$</span>median</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>W <span class="ot">&lt;-</span> pred<span class="sc">$</span>median</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pred) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="fu">c</span>(<span class="st">"W"</span>,<span class="st">"FixedEffect"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pedometron_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="final-remarks" class="level1">
<h1>Final remarks</h1>
<p>The goal of <a href="http://inlabru.org/">inlabru</a> is to facilitate spatial modeling using integrated nested Laplace approximation via the <a href="https://www.r-inla.org/">R-INLA package</a>. The recent developments allow now to construct in a convenient way Bayesian spatial model (INLA-SPDE) of soil properties and their uncertainty. Model components are specified with general inputs and mapping methods to the latent variables, and the predictors are specified via general R expressions.</p>
<p>In their study, Poggio et al. <span class="citation" data-cites="Poggio2016">(<a href="#ref-Poggio2016" role="doc-biblioref">2016</a>)</span> and Huang et al. <span class="citation" data-cites="Huang2017">(<a href="#ref-Huang2017" role="doc-biblioref">2017</a>)</span> reported that INLA-SPDE became quite slow when estimating the posterior marginal distributions of the environmental variables associated with large datasets. When the number of observations is huge, it is important to mention that one can improve the performance of the high-dimensional matrix computations conducted in INLA by using the PARDISO solver library. It is already full included in the standard INLA installation but has to be activated through a licence key. To activate it (free for non commercial uses), go to https://www.pardiso-project.org/r-inla/#license to obtain the license, which will take you at most several minutes. Also, you can type inla.pardiso() at the R command line for viewing the (very simple) instructions on how to enable the PARDISO sparse library. Moreover, new developments are underway for especially data-rich model to achieve even faster inference, improved numerical stability and scalability using variational approximation <span class="citation" data-cites="VANNIEKERK2023107692">(<a href="#ref-VANNIEKERK2023107692" role="doc-biblioref">Van Niekerk et al. 2023</a>)</span>.</p>
<p>Heuvelink and Webster <span class="citation" data-cites="HEUVELINK2022100639">(<a href="#ref-HEUVELINK2022100639" role="doc-biblioref">2022</a>)</span> listed a set of challenges for pedometricians and spatial statisticians to strengthen the role of spatial statistics. Without being able to solve all of them, it seems to us that <code>INLA</code> by providing a fully Bayesian modelling in a rapid and convinent way can provide some answers to some of them, e.g., the better uncertainty quantification, the change of support, incorporating attribute and positional measurement uncertainty.</p>
</section>
<section id="code-availability" class="level1">
<h1>Code availability</h1>
<p>The code is also available on github : https://github.com/nsaby/pedometron042023</p>
<p>More codes are available here: https://inlabru-org.github.io/inlabru/articles/web/random_fields_2d.html</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-HEUVELINK2022100639" class="csl-entry" role="doc-biblioentry">
Heuvelink, Gerard B. M., and Richard Webster. 2022. <span>“Spatial Statistics and Soil Mapping: A Blossoming Partnership Under Pressure.”</span> <em>Spatial Statistics</em> 50: 100639. https://doi.org/<a href="https://doi.org/10.1016/j.spasta.2022.100639">https://doi.org/10.1016/j.spasta.2022.100639</a>.
</div>
<div id="ref-Huang2017" class="csl-entry" role="doc-biblioentry">
Huang, Malone, J. 2017. <span>“<span class="nocase">Evaluating a Bayesian modelling approach (INLA-SPDE) for environmental mapping</span>.”</span> <em>Science of The Total Environment</em> 609: 621--632.
</div>
<div id="ref-Lindgren2011" class="csl-entry" role="doc-biblioentry">
Lindgren, Finn, Håvard Rue, and Johan Lindström. 2011. <span>“<span class="nocase">An explicit link between Gaussian fields and Gaussian Markov random fields: the stochastic partial differential equation approach</span>.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 73 (4): 423–98.
</div>
<div id="ref-Poggio2016" class="csl-entry" role="doc-biblioentry">
Poggio, Laura, Alessandro Gimona, Luigi Spezia, and Mark J Brewer. 2016. <span>“<span class="nocase">Bayesian spatial modelling of soil properties and their uncertainty: The example of soil organic matter in Scotland using R-INLA</span>.”</span> <em>Geoderma</em> 277: 69–82.
</div>
<div id="ref-poggio_soilgrids_2021" class="csl-entry" role="doc-biblioentry">
Poggio, L., L. M. de Sousa, N. H. Batjes, G. B. M. Heuvelink, B. Kempen, E. Ribeiro, and D. Rossiter. 2021. <span>“<span>SoilGrids</span> 2.0: Producing Soil Information for the Globe with Quantified Spatial Uncertainty.”</span> <em>SOIL</em> 7 (1): 217–40. <a href="https://doi.org/10.5194/soil-7-217-2021">https://doi.org/10.5194/soil-7-217-2021</a>.
</div>
<div id="ref-Rue2009" class="csl-entry" role="doc-biblioentry">
Rue, Håvard, Sara Martino, and Nicolas Chopin. 2009. <span>“<span class="nocase">Approximate Bayesian inference for latent Gaussian models by using integrated nested Laplace approximations</span>.”</span> <em>Journal of the Royal Statistical Society: Series b (Statistical Methodology)</em> 71 (2): 319–92.
</div>
<div id="ref-VANNIEKERK2023107692" class="csl-entry" role="doc-biblioentry">
Van Niekerk, Janet, Elias Krainski, Denis Rustand, and Håvard Rue. 2023. <span>“A New Avenue for Bayesian Inference with INLA.”</span> <em>Computational Statistics &amp; Data Analysis</em> 181: 107692. https://doi.org/<a href="https://doi.org/10.1016/j.csda.2023.107692">https://doi.org/10.1016/j.csda.2023.107692</a>.
</div>
<div id="ref-yuan2017point" class="csl-entry" role="doc-biblioentry">
Yuan, Y., F. E. Bachl, F. Lindgren, D. L. Brochers, J. B. Illian, S. T. Buckland, H. Rue, and T. Gerrodette. 2017. <span>“Point Process Models for Spatio-Temporal Distance Sampling Data from a Large-Scale Survey of Blue Whales.”</span> <a href="https://arxiv.org/abs/1604.06013">https://arxiv.org/abs/1604.06013</a>.
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>